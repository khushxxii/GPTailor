<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPTailor | Tailor Your Resume</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
            width: 100%;
        }

        /* Header */
        .top-header {
            background: white;
            border-bottom: 1px solid #e0e0e0;
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-weight: 600;
            font-size: 14px;
            color: #333;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo img {
            height: 32px;
            width: auto;
        }

        .header-nav {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .header-nav select {
            border: none;
            background: transparent;
            font-size: 14px;
            color: #666;
            cursor: pointer;
            padding: 4px 8px;
        }

        .header-nav select:hover {
            color: #333;
        }

        .re-score-btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .re-score-btn:hover {
            background: #1d4ed8;
        }

        .secondary-nav {
            background: white;
            border-bottom: 1px solid #e0e0e0;
            padding: 8px 24px;
            display: flex;
            gap: 16px;
        }

        .secondary-nav button {
            background: transparent;
            border: none;
            color: #666;
            font-size: 13px;
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .secondary-nav button:hover {
            background: #f5f5f5;
            color: #333;
        }

        /* Main Layout */
        .main-layout {
            display: flex;
            flex: 1;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        /* Left Sidebar */
        .sidebar {
            width: 280px;
            min-width: 280px;
            background: white;
            border-right: 1px solid #e0e0e0;
            padding: 24px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .score-gauge {
            text-align: center;
            margin-bottom: 32px;
        }

        .gauge-circle {
            width: 180px;
            height: 180px;
            margin: 0 auto 16px;
            position: relative;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: conic-gradient(
                from 0deg,
                #ef4444 0deg,
                #f59e0b 90deg,
                #eab308 180deg,
                #84cc16 270deg,
                #10b981 360deg
            );
        }

        .gauge-circle::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            background: conic-gradient(
                from 0deg,
                transparent 0deg,
                transparent calc(var(--score) * 3.6deg),
                #e5e7eb calc(var(--score) * 3.6deg),
                #e5e7eb 360deg
            );
            mask: radial-gradient(circle at center, transparent 70px, black 70px);
            -webkit-mask: radial-gradient(circle at center, transparent 70px, black 70px);
            z-index: 1;
        }

        .gauge-inner {
            width: 140px;
            height: 140px;
            background: white;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 2;
        }

        .score-number {
            font-size: 36px;
            font-weight: 700;
            color: #333;
        }

        .score-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 0;
            color: #666;
            text-decoration: none;
            font-size: 14px;
            transition: color 0.2s;
        }

        .nav-item:hover {
            color: #2563eb;
        }

        .nav-item svg {
            width: 18px;
            height: 18px;
        }

        .section-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: #666;
            letter-spacing: 0.5px;
            margin: 24px 0 12px;
        }

        .issue-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            font-size: 14px;
            color: #333;
            cursor: pointer;
            transition: color 0.2s;
        }

        .issue-item:hover {
            color: #2563eb;
        }

        .issue-count {
            background: #ef4444;
            color: white;
            font-size: 12px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 12px;
            min-width: 24px;
            text-align: center;
        }

        .issue-lock {
            color: #9ca3af;
            font-size: 16px;
        }

        .completed-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
            color: #333;
        }

        .completed-score {
            color: #10b981;
            font-weight: 600;
            font-size: 14px;
        }

        .more-btn {
            background: transparent;
            border: 1px solid #e0e0e0;
            color: #666;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            width: 100%;
            margin-top: 8px;
            transition: all 0.2s;
        }

        .more-btn:hover {
            background: #f5f5f5;
            border-color: #d0d0d0;
        }

        .tool-item {
            padding: 8px 0;
            font-size: 14px;
            color: #666;
            cursor: pointer;
            transition: color 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .tool-item:hover {
            color: #2563eb;
        }

        .tool-item-soon {
            font-size: 10px;
            color: #9ca3af;
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 8px;
            pointer-events: none;
        }

        .resources-link {
            display: block;
            margin-top: 24px;
            font-size: 13px;
            color: #666;
            text-decoration: none;
        }

        .resources-link:hover {
            color: #2563eb;
        }

        /* Promotional Content Styles */
        .promo-stat {
            text-align: center;
            padding: 24px;
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            border-radius: 12px;
            margin-bottom: 24px;
            color: white;
        }

        .promo-stat-number {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .promo-stat-label {
            font-size: 13px;
            opacity: 0.9;
        }

        .promo-feature {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 16px;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .promo-feature:hover {
            background: #f0f7ff;
            transform: translateX(4px);
        }

        .promo-feature-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .promo-feature-text {
            flex: 1;
        }

        .promo-feature-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .promo-feature-desc {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }


        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            gap: 24px;
            padding: 24px;
            min-width: 0;
        }

        .content-left {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
        }

        .content-right {
            width: 400px;
            min-width: 400px;
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            max-height: calc(100vh - 150px);
            overflow-y: auto;
            flex-shrink: 0;
        }

        .welcome-section {
            margin-bottom: 32px;
        }

        .welcome-nav {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .nav-arrow {
            background: rgba(0, 0, 0, 0.96);
            border: 1px solid #e0e0e0;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            color: white;
        }

        .nav-arrow:hover {
            background: rgba(0, 0, 0, 0.8);
            border-color: #d0d0d0;
        }

        .how-it-works-btn {
            background: rgba(33, 93, 232, 0.8);
            border: 1px solid #e0e0e0;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            color: white;
        }

        .how-it-works-btn:hover {
            background: rgba(33, 93, 232, 0.8);
        }

        .welcome-text {
            font-size: 16px;
            color: #666;
        }

        .score-section {
            background: white;
            border-radius: 8px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .score-heading {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #333;
        }

        .score-description {
            color: #666;
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 24px;
        }

        .score-bar-container {
            position: relative;
            height: 40px;
            background: linear-gradient(to right, #ef4444 0%, #f59e0b 25%, #eab308 50%, #84cc16 75%, #10b981 100%);
            border-radius: 20px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .score-bar {
            position: absolute;
            top: 50%;
            left: var(--score-percent);
            transform: translate(-50%, -50%);
            width: 4px;
            height: 60px;
            background: #7c3aed;
            z-index: 2;
        }

        .score-bar::before {
            content: 'YOUR RESUME';
            position: absolute;
            top: -24px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            font-weight: 600;
            color: #7c3aed;
            white-space: nowrap;
        }

        .top-resumes-line {
            position: absolute;
            top: 50%;
            right: 10%;
            transform: translateY(-50%);
            width: 2px;
            height: 60px;
            border-left: 2px dashed #666;
            z-index: 1;
        }

        .top-resumes-line::before {
            content: 'TOP RESUMES';
            position: absolute;
            top: -24px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            font-weight: 600;
            color: #666;
            white-space: nowrap;
        }

        .tip-box {
            display: flex;
            gap: 12px;
            padding: 16px;
            background: #fef3c7;
            border-radius: 8px;
            margin-top: 16px;
        }

        .tip-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .tip-text {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
        }

        .issues-section {
            background: white;
            border-radius: 8px;
            padding: 32px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .issues-heading {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #333;
        }

        .issue-card {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 16px;
            transition: all 0.2s;
            box-sizing: border-box;
            width: 100%;
            overflow: hidden;
        }

        .issue-card:hover {
            border-color: #2563eb;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
        }

        .issue-info {
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }

        .issue-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .issue-icon {
            color: #ef4444;
            font-size: 20px;
        }

        .issue-desc {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }

        .fix-btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
            white-space: nowrap;
            flex-shrink: 0;
            max-width: 100%;
            box-sizing: border-box;
        }

        .fix-btn:hover {
            background: #1d4ed8;
        }

        /* Resume Display */
        .resume-display {
            font-size: 13px;
            line-height: 1.6;
        }

        .resume-name {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #333;
        }

        .resume-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 16px;
        }

        .resume-contact {
            font-size: 12px;
            color: #666;
            margin-bottom: 24px;
            line-height: 1.8;
        }

        .resume-section {
            margin-bottom: 24px;
        }

        .resume-section-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: #333;
            margin-bottom: 12px;
            letter-spacing: 0.5px;
        }

        .resume-item {
            margin-bottom: 16px;
        }

        .resume-item-title {
            font-weight: 600;
            font-size: 13px;
            color: #333;
            margin-bottom: 4px;
        }

        .resume-item-subtitle {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .resume-item-bullets {
            list-style: none;
            padding-left: 0;
        }

        .resume-item-bullets li {
            font-size: 12px;
            color: #666;
            margin-bottom: 6px;
            padding-left: 16px;
            position: relative;
        }

        .resume-item-bullets li::before {
            content: '‚Ä¢';
            position: absolute;
            left: 0;
            color: #2563eb;
        }

        .resume-skills {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .skill-tag {
            background: #f5f5f5;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            color: #666;
        }

        /* Upload Section */
        .upload-section {
            background: white;
            border-radius: 8px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
            box-sizing: border-box;
        }

        .upload-area {
            border: 2px dashed #d0d0d0;
            border-radius: 8px;
            padding: 40px 20px;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            box-sizing: border-box;
        }

        .upload-area:hover {
            border-color: #2563eb;
            background: #f0f7ff;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 16px;
            color: #9ca3af;
        }

        .upload-text {
            font-size: 16px;
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
        }

        .upload-hint {
            font-size: 13px;
            color: #666;
        }

        .upload-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 32px;
            width: 100%;
            box-sizing: border-box;
        }

        .upload-grid > div {
            display: flex;
            flex-direction: column;
            min-width: 0;
            width: 100%;
            box-sizing: border-box;
        }

        .hidden-file-input {
            display: none;
        }

        .toggle-btn {
            background: #f5f5f5;
            border: 1px solid #e0e0e0;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 8px;
            color: #666;
        }

        .toggle-btn:hover {
            background: #e5e5e5;
        }

        .toggle-btn.active {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        #analyzeBtn {
            border-radius: 10px;
            background: #9ca3af;
            color: white;
            border: none;
            cursor: not-allowed;
            transition: all 0.3s ease;
        }

        #analyzeBtn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            opacity: 1;
        }

        #analyzeBtn.ready {
            background: #2563eb;
            cursor: pointer;
        }

        #analyzeBtn.ready:hover:not(:disabled) {
            background: #1d4ed8;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2563eb;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
            }

            .content-right {
                width: 100%;
            }
        }

        @media (max-width: 1024px) {
            .upload-grid {
                grid-template-columns: 1fr !important;
                gap: 20px !important;
            }

            .upload-section {
                padding: 24px;
            }

            .main-content {
                padding: 20px;
            }

            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
            }

            .main-layout {
                flex-direction: column;
            }
        }

        @media (max-width: 768px) {
            .main-layout {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
            }

            .top-header {
                flex-wrap: wrap;
                padding: 12px 16px;
            }

            .header-nav {
                flex-wrap: wrap;
            }

            .main-content {
                padding: 16px;
                gap: 16px;
            }

            .upload-section {
                padding: 20px;
                margin-bottom: 16px;
            }

            .upload-grid {
                grid-template-columns: 1fr !important;
                gap: 16px !important;
                margin-bottom: 24px !important;
            }

            .upload-area {
                padding: 30px 16px;
                min-height: 120px;
            }

            .upload-icon {
                font-size: 36px;
                margin-bottom: 12px;
            }

            .upload-text {
                font-size: 14px;
            }

            .upload-hint {
                font-size: 12px;
            }

            .content-right {
                width: 100%;
                min-width: 100%;
                padding: 16px;
            }

            .score-section {
                padding: 20px;
            }

            .issues-section {
                padding: 20px;
            }

            .issue-card {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .fix-btn {
                width: 100%;
                max-width: 100%;
            }
            
            .issue-info {
                width: 100%;
            }

            #analyzeBtn {
                width: 100%;
                min-width: auto;
                padding: 12px 24px;
                font-size: 14px;
            }

            .how-it-works-btn {
                width: 100%;
                margin-bottom: 12px !important;
            }

            textarea {
                font-size: 14px !important;
                padding: 10px !important;
            }

            .toggle-btn {
                flex: 1;
                font-size: 11px;
                padding: 8px 10px;
            }

            .logo span {
                font-size: 12px;
            }

            .logo img {
                height: 24px;
            }
        }

        @media (max-width: 480px) {
            body {
                overflow-x: hidden;
            }

            .upload-section {
                padding: 16px;
            }

            .upload-area {
                padding: 24px 12px;
                min-height: 100px;
            }

            .upload-icon {
                font-size: 32px;
            }

            .main-content {
                padding: 12px;
            }

            .top-header {
                padding: 10px 12px;
            }

            .logo span {
                font-size: 11px;
            }
        }

        /* Footer */
        .footer {
            background: white;
            border-top: 1px solid #e0e0e0;
            padding: 8px 24px;
            text-align: center;
            color: #666;
            font-size: 11px;
            margin-top: auto;
            opacity: 0.6;
            display: none;
        }

        .footer-counter {
            font-weight: 500;
            color: #2563eb;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <!-- Top Header -->
    <div class="top-header">
        <a href="#" class="logo">
            <img src="logo.png" alt="GPTailor Logo">
            <span>GPTAILOR | TAILOR YOUR RESUME</span>
        </a>
        <div class="header-nav">
            <button class="re-score-btn" onclick="showUpload()">New Analysis</button>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="main-layout">
        <!-- Left Sidebar -->
        <div class="sidebar" id="sidebar" style="display: block;">
            <!-- Promotional Content (shown before analysis) -->
            <div id="promoContent">
                <div style="text-align: center; margin-bottom: 32px;">
                    <img src="logo.png" alt="GPTailor Logo" style="height: 64px; width: auto; margin-bottom: 16px;">
                    <h2 style="font-size: 20px; font-weight: 700; color: #333; margin-bottom: 8px;">Tailor Your Resume</h2>
                    <p style="font-size: 14px; color: #666; line-height: 1.5;">Get instant feedback and boost your chances of landing that interview</p>
                </div>

                <div class="promo-stat">
                    <div class="promo-stat-number">+25</div>
                    <div class="promo-stat-label">Average Score Increase</div>
                </div>

                <div class="promo-feature">
                    <div class="promo-feature-icon">ñ£†</div>
                    <div class="promo-feature-text">
                        <div class="promo-feature-title">ATS Optimization</div>
                        <div class="promo-feature-desc">Match keywords recruiters are looking for</div>
                    </div>
                </div>

                <div class="promo-feature">
                    <div class="promo-feature-icon">‚Çä‚ü°</div>
                    <div class="promo-feature-text">
                        <div class="promo-feature-title">Smart Suggestions</div>
                        <div class="promo-feature-desc">AI-powered recommendations tailored to your job</div>
                    </div>
                </div>

                <div class="promo-feature">
                    <div class="promo-feature-icon">ìäç</div>
                    <div class="promo-feature-text">
                        <div class="promo-feature-title">Instant Scoring</div>
                        <div class="promo-feature-desc">See how well your resume matches in seconds</div>
                    </div>
                </div>
            </div>

            <!-- Functional Content (shown after analysis) -->
            <div id="functionalContent" style="display: none;">
            <div class="score-gauge" id="scoreGaugeContainer" style="display: none;">
                <div class="gauge-circle low" id="scoreGauge" style="--score: 0">
                    <div class="gauge-inner">
                        <div class="score-number" id="scoreNumber">0</div>
                        <div class="score-label">OVERALL</div>
                    </div>
                </div>
            </div>

            <div class="section-title" id="topFixesTitle" style="display: none;">TOP FIXES</div>
            <div id="topFixesList">
                <!-- Will be populated by JavaScript -->
            </div>
            <button class="more-btn" id="moreIssuesBtn" onclick="showAllIssues()" style="display: none;">10 MORE ISSUES +</button>

            <div class="section-title" id="completedTitle" style="display: none;">COMPLETED</div>
            <div id="completedList">
                <!-- Will be populated by JavaScript -->
            </div>

            <div class="section-title" id="toolsTitle" style="display: none;">TOOLS</div>
            <div id="toolsList" style="display: none;">
                <div class="tool-item" onclick="rewriteResume()" style="cursor: pointer;">Rewrite My Resume<span class="tool-item-soon">Soon</span></div>
                <div class="tool-item" onclick="optimizeATS()" style="cursor: pointer;">Optimize ATS Keywords</div>
                <div class="tool-item" onclick="addMissingQualifications()" style="cursor: pointer;">Add Missing Qualifications</div>
                <div class="tool-item" onclick="improveBullets()" style="cursor: pointer;">Improve Bullet Points<span class="tool-item-soon">Soon</span></div>
                <div class="tool-item" onclick="addQuantification()" style="cursor: pointer;">Add Quantification<span class="tool-item-soon">Soon</span></div>
            </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="content-left">
                <!-- Upload Section (shown initially) -->
                <div class="upload-section" id="uploadSection">
                    <div class="upload-grid">
                        <!-- Resume Upload -->
                        <div style="display: flex; flex-direction: column;">
                            <label style="display: block; font-weight: 600; margin-bottom: 12px; font-size: 14px; color: #333;">Your Resume</label>
                            <div class="upload-area" onclick="document.getElementById('resumeFileInput').click()">
                                <div class="upload-icon"></div>
                                <div class="upload-text">Upload Resume</div>
                                <div class="upload-hint">PDF, DOC, or paste text</div>
                            </div>
                            <input type="file" id="resumeFileInput" class="hidden-file-input" accept=".pdf,.doc,.docx" onchange="handleFileUpload('resume', event)">
                            <div id="resumeFileError" style="display: none; margin-top: 8px; padding: 8px; border-radius: 6px; font-size: 12px; background: #fee2e2; color: #991b1b;"></div>
                            <textarea id="resumeTextInput" placeholder="Or paste your resume text here..." maxlength="20000" style="display: none; width: 100%; min-height: 150px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; margin-top: 12px; font-size: 13px; font-family: inherit; resize: vertical; box-sizing: border-box;"></textarea>
                            <div id="resumeTextCount" style="display: none; margin-top: 4px; font-size: 11px; color: #666; text-align: right;"></div>
                            <div id="resumeTextError" style="display: none; margin-top: 8px; padding: 8px; border-radius: 6px; font-size: 12px; background: #fee2e2; color: #991b1b;"></div>
                            <div style="margin-top: 12px; display: flex; gap: 8px;">
                                <button type="button" class="toggle-btn active" onclick="toggleInputMode('resume', 'file')" id="resumeFileBtn">Upload</button>
                                <button type="button" class="toggle-btn" onclick="toggleInputMode('resume', 'text')" id="resumeTextBtn">Paste Text</button>
                            </div>
                        </div>
                        
                        <!-- Job Posting Upload -->
                        <div style="display: flex; flex-direction: column;">
                            <label style="display: block; font-weight: 600; margin-bottom: 12px; font-size: 14px; color: #333;">Job Posting</label>
                            <div class="upload-area" onclick="document.getElementById('jobFileInput').click()">
                                <div class="upload-icon"></div>
                                <div class="upload-text">Upload Job Posting</div>
                                <div class="upload-hint">PDF, DOC, paste text, or paste URL</div>
                            </div>
                            <input type="file" id="jobFileInput" class="hidden-file-input" accept=".pdf,.doc,.docx" onchange="handleFileUpload('job', event)">
                            <div id="jobFileError" style="display: none; margin-top: 8px; padding: 8px; border-radius: 6px; font-size: 12px; background: #fee2e2; color: #991b1b;"></div>
                            <textarea id="jobTextInput" placeholder="Or paste the job description here..." maxlength="10000" style="display: none; width: 100%; min-height: 150px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; margin-top: 12px; font-size: 13px; font-family: inherit; resize: vertical; box-sizing: border-box;"></textarea>
                            <div id="jobTextCount" style="display: none; margin-top: 4px; font-size: 11px; color: #666; text-align: right;"></div>
                            <div id="jobTextError" style="display: none; margin-top: 8px; padding: 8px; border-radius: 6px; font-size: 12px; background: #fee2e2; color: #991b1b;"></div>
                            <input type="url" id="jobUrlInput" placeholder="Paste job posting URL here (e.g., LinkedIn, Indeed, etc.)" style="display: none; width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; margin-top: 12px; font-size: 13px; font-family: inherit; box-sizing: border-box;">
                            <div id="jobUrlStatus" style="display: none; margin-top: 8px; padding: 8px; border-radius: 6px; font-size: 12px;"></div>
                            <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
                                <button type="button" class="toggle-btn active" onclick="toggleInputMode('job', 'file')" id="jobFileBtn">Upload</button>
                                <button type="button" class="toggle-btn" onclick="toggleInputMode('job', 'text')" id="jobTextBtn">Paste Text</button>
                                <button type="button" class="toggle-btn" onclick="toggleInputMode('job', 'url')" id="jobUrlBtn">Paste URL</button>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 24px;">
                        <button class="how-it-works-btn" onclick="showHowItWorks()" style="margin-bottom: 16px; padding: 10px 20px; font-size: 14px;">HOW IT WORKS</button>
                        <div style="margin-top: 16px;">
                        <button class="review-btn" onclick="analyzeResume()" id="analyzeBtn" style="padding: 14px 32px; font-size: 16px; min-width: 250px;" disabled>
                            Analyze & Score Resume
                        </button>
                        </div>
                    </div>
                </div>

                <!-- Results Section (hidden initially) -->
                <div id="resultsSection" style="display: none;">
                    <div class="welcome-section">
                        <div class="welcome-text" id="welcomeText">Good evening, Khushi. Welcome to your resume review.</div>
                    </div>

                    <div class="score-section">
                        <h2 class="score-heading" id="scoreHeading">Your resume scored 36 out of 100.</h2>
                        <p class="score-description" id="scoreDescription">
                            This score reflects how well your resume aligns with this specific job posting. We've identified key areas where your resume can be improved to better match what recruiters are looking for. Review the suggestions below to boost your score and increase your chances of landing an interview.
                        </p>
                        <div class="score-bar-container">
                            <div class="score-bar" id="scoreBar" style="--score-percent: 36%"></div>
                            <div class="top-resumes-line"></div>
                        </div>
                        <div class="tip-box">
                            <div class="tip-icon"></div>
                            <div class="tip-text">
                                Use the feedback to find and fix errors in your resume, then reupload it to get a new score. 80% of people increase their score by over 20 points with just three uploads and revisions.
                            </div>
                        </div>
                    </div>

                    <div class="issues-section">
                        <h3 class="issues-heading">Here are the key areas where your resume can better match the job posting. Click into each to learn specific improvements you can make.</h3>
                        <div id="issuesList">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Loading State -->
                <div class="loading" id="loadingSection" style="display: none;">
                    <div class="spinner"></div>
                    <div>Analyzing your resume against the job posting...</div>
                </div>
            </div>

            <!-- Right Sidebar - Resume Display -->
            <div class="content-right" id="resumeDisplay" style="display: none;">
                <div class="resume-display" id="resumeContent">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <span class="footer-counter" id="resumeCount">0</span> people have checked their resumes
    </footer>

    <script>
        // Text length limits
        const MAX_RESUME_LENGTH = 20000; // ~3-4 pages
        const MAX_JOB_POSTING_LENGTH = 10000; // ~2 pages
        
        let currentAnalysis = null;
        let currentResumeText = '';
        let currentJobPostingText = '';
        let inputModes = { resume: 'file', job: 'file' };
        let urlInputTimeout = null;

        function showUpload() {
            document.getElementById('uploadSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('resumeDisplay').style.display = 'none';
            document.getElementById('loadingSection').style.display = 'none';
            // Show sidebar with promotional content
            document.getElementById('sidebar').style.display = 'block';
            document.getElementById('promoContent').style.display = 'block';
            document.getElementById('functionalContent').style.display = 'none';
            // Hide score sections when returning to upload
            document.getElementById('scoreGaugeContainer').style.display = 'none';
            document.getElementById('topFixesTitle').style.display = 'none';
            document.getElementById('completedTitle').style.display = 'none';
            document.getElementById('moreIssuesBtn').style.display = 'none';
            document.getElementById('topFixesList').innerHTML = '';
            document.getElementById('completedList').innerHTML = '';
            // Hide tools section
            document.getElementById('toolsTitle').style.display = 'none';
            document.getElementById('toolsList').style.display = 'none';
        }

        function updateTextCount(type) {
            const textInput = document.getElementById(`${type}TextInput`);
            const countDiv = document.getElementById(`${type}TextCount`);
            const errorDiv = document.getElementById(`${type}TextError`);
            
            if (!textInput || !countDiv) return;
            
            if (textInput.style.display !== 'none') {
                const length = textInput.value.length;
                const maxLength = type === 'resume' ? MAX_RESUME_LENGTH : MAX_JOB_POSTING_LENGTH;
                const remaining = maxLength - length;
                
                countDiv.style.display = 'block';
                countDiv.textContent = `${length.toLocaleString()} / ${maxLength.toLocaleString()} characters`;
                
                if (length > maxLength * 0.9) {
                    countDiv.style.color = remaining < 0 ? '#dc2626' : '#f59e0b';
                } else {
                    countDiv.style.color = '#666';
                }
                
                // Show error if over limit
                if (length > maxLength) {
                    if (errorDiv) {
                        errorDiv.style.display = 'block';
                        errorDiv.textContent = `Text is too long. Maximum ${maxLength.toLocaleString()} characters allowed. Please shorten your text.`;
                    }
                } else {
                    if (errorDiv) {
                        errorDiv.style.display = 'none';
                    }
                }
            } else {
                countDiv.style.display = 'none';
                if (errorDiv) errorDiv.style.display = 'none';
            }
        }

        function toggleInputMode(type, mode) {
            inputModes[type] = mode;
            const fileInput = document.getElementById(`${type}FileInput`);
            const textInput = document.getElementById(`${type}TextInput`);
            const urlInput = document.getElementById(`${type}UrlInput`);
            const urlStatus = document.getElementById(`${type}UrlStatus`);
            const fileBtn = document.getElementById(`${type}FileBtn`);
            const textBtn = document.getElementById(`${type}TextBtn`);
            const urlBtn = document.getElementById(`${type}UrlBtn`);
            const container = fileInput.closest('div');
            const uploadArea = container.querySelector('.upload-area');

            // Hide all inputs first
            if (fileInput) fileInput.style.display = 'none';
            if (textInput) textInput.style.display = 'none';
            if (urlInput) urlInput.style.display = 'none';
            if (urlStatus) urlStatus.style.display = 'none';
            
            // Remove active class from all buttons
            if (fileBtn) fileBtn.classList.remove('active');
            if (textBtn) textBtn.classList.remove('active');
            if (urlBtn) urlBtn.classList.remove('active');

            if (mode === 'file') {
                if (fileInput) fileInput.style.display = 'block';
                if (uploadArea) uploadArea.style.display = 'block';
                if (fileBtn) fileBtn.classList.add('active');
                // Hide text count and error
                const countDiv = document.getElementById(`${type}TextCount`);
                const errorDiv = document.getElementById(`${type}TextError`);
                if (countDiv) countDiv.style.display = 'none';
                if (errorDiv) errorDiv.style.display = 'none';
            } else if (mode === 'url' && type === 'job') {
                // URL mode only for job posting
                if (urlInput) urlInput.style.display = 'block';
                if (uploadArea) uploadArea.style.display = 'none';
                if (urlBtn) urlBtn.classList.add('active');
                // Hide text count and error
                const countDiv = document.getElementById(`${type}TextCount`);
                const errorDiv = document.getElementById(`${type}TextError`);
                if (countDiv) countDiv.style.display = 'none';
                if (errorDiv) errorDiv.style.display = 'none';
            } else {
                // Text mode
                if (textInput) textInput.style.display = 'block';
                if (uploadArea) uploadArea.style.display = 'none';
                if (textBtn) textBtn.classList.add('active');
                // Show character count
                updateTextCount(type);
            }
            
            // Check if inputs are ready after mode change
            checkInputsReady();
        }

        async function handleFileUpload(type, event) {
            const file = event.target.files[0];
            if (!file) {
                checkInputsReady();
                return;
            }

            // Store file info for later
            const fileName = file.name;
            const fileType = file.type;
            
            // Show file name - find the upload area in the same parent container as the file input
            // The file input and upload-area are siblings within a flex column container
            const fileInput = event.target;
            const parentContainer = fileInput.parentElement; // Gets the flex column container
            const uploadArea = parentContainer.querySelector('.upload-area');
            
            if (uploadArea) {
                uploadArea.querySelector('.upload-text').textContent = `‚úì ${fileName}`;
            }
            
            // Check if both inputs are ready
            checkInputsReady();
        }

        function getInputValue(type) {
            if (inputModes[type] === 'text') {
                const textInput = document.getElementById(`${type}TextInput`);
                return textInput ? textInput.value.trim() : '';
            } else if (inputModes[type] === 'url' && type === 'job') {
                const urlInput = document.getElementById(`${type}UrlInput`);
                return urlInput ? urlInput.value.trim() : '';
            } else {
                const fileInput = document.getElementById(`${type}FileInput`);
                // Check for drag-and-drop file stored on the element
                return fileInput ? (fileInput.files[0] || fileInput._droppedFile || null) : null;
            }
        }

        async function fetchUrlContent(url) {
            try {
                const urlStatus = document.getElementById('jobUrlStatus');
                if (urlStatus) {
                    urlStatus.style.display = 'block';
                    urlStatus.style.background = '#fef3c7';
                    urlStatus.style.color = '#92400e';
                    urlStatus.textContent = 'Fetching job posting from URL...';
                }

                // Use a CORS proxy or backend endpoint to fetch the URL
                // Since we can't directly fetch from client due to CORS, we'll use the backend
                const response = await fetch('/api/fetch-url', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Failed to fetch URL content' }));
                    
                    // Handle specific error types with helpful messages
                    if (errorData.error === 'ACCESS_REQUIRED' && errorData.message) {
                        throw new Error('ACCESS_REQUIRED:' + errorData.message);
                    }
                    if (errorData.error === 'NOT_FOUND' && errorData.message) {
                        throw new Error('NOT_FOUND:' + errorData.message);
                    }
                    
                    throw new Error(errorData.error || errorData.message || 'Failed to fetch URL content');
                }

                const data = await response.json();
                
                if (urlStatus) {
                    urlStatus.style.background = '#d1fae5';
                    urlStatus.style.color = '#065f46';
                    urlStatus.textContent = '‚úì Successfully fetched job posting content';
                }
                
                return data.content;
            } catch (error) {
                const urlStatus = document.getElementById('jobUrlStatus');
                if (urlStatus) {
                    urlStatus.style.display = 'block';
                    urlStatus.style.background = '#fee2e2';
                    urlStatus.style.color = '#991b1b';
                    
                    let errorMsg = error.message;
                    let showSuggestions = false;
                    
                    // Handle specific error types
                    if (errorMsg.startsWith('ACCESS_REQUIRED:')) {
                        errorMsg = errorMsg.replace('ACCESS_REQUIRED:', '');
                        showSuggestions = true;
                    } else if (errorMsg.startsWith('NOT_FOUND:')) {
                        errorMsg = errorMsg.replace('NOT_FOUND:', '');
                    } else if (errorMsg.includes('Could not extract meaningful content')) {
                        errorMsg = 'This website uses JavaScript to load content. Please choose a different upload method instead. (e.g. "Paste Text" or "Upload")';
                    }
                    
                    // Create a more detailed error display with suggestions
                    if (showSuggestions) {
                        urlStatus.innerHTML = `
                            <div style="margin-bottom: 8px; font-weight: 600;">‚ö†Ô∏è This URL requires login or special access</div>
                            <div style="font-size: 11px; line-height: 1.5;">
                                <strong>Try one of these alternatives:</strong><br>
                                1. Copy the job description text and use "Paste Text"<br>
                                2. Save the page as a PDF and use "Upload"
                            </div>
                        `;
                    } else {
                        urlStatus.textContent = '‚úó ' + errorMsg;
                    }
                }
                console.error('Error fetching URL:', error);
                throw error;
            }
        }

        function detectContentType(text) {
            if (!text || typeof text !== 'string') return 'unknown';
            
            const lowerText = text.toLowerCase();
            
            // Strong resume indicators (more specific, less likely in job postings)
            const strongResumeIndicators = [
                /\b(resume|cv|curriculum vitae)\b/i,
                /^\s*[A-Z][a-z]+\s+[A-Z][a-z]+/m, // Name pattern at start (e.g., "John Doe")
                /\b(objective|summary|profile)\s*:?\s*$/im, // Resume sections
                /\b(references\s*(available|upon\s*request)|references\s*:)/i,
                /\b(professional\s*summary|executive\s*summary)/i,
                /\b(work\s*experience|employment\s*history|professional\s*experience)\s*:?/i,
                /\b(phone|email|address|contact)\s*:?\s*[^\n]{5,}/i, // Contact info with actual content
            ];
            
            // Moderate resume indicators (can appear in both, but more common in resumes)
            const moderateResumeIndicators = [
                /\b(certifications|awards|honors|publications)\s*:?/i,
                /\b(education\s*background|academic\s*background)/i,
                /\b(technical\s*skills|core\s*competencies)\s*:?/i,
            ];
            
            // Strong job posting indicators (very specific to job postings)
            const strongJobIndicators = [
                /\b(job\s*(posting|description|ad|listing|opening)|position\s*description|role\s*description)\b/i,
                /\b(we\s*are\s*(looking|seeking|hiring|recruiting)|we\s*have\s*an?\s*opening)/i,
                /\b(apply\s*(now|today|online)|submit\s*your\s*(application|resume)|send\s*resume)/i,
                /\b(qualifications?\s*(required|needed)|requirements?\s*(for|of))/i,
                /\b(responsibilities?\s*(include|are)|key\s*duties|essential\s*functions)/i,
                /\b(salary\s*(range|package)|compensation\s*package|competitive\s*salary)/i,
                /\b(benefits\s*(package|include|offered)|employee\s*benefits)/i,
                /\b(about\s*(the\s*company|us)|company\s*overview|who\s*we\s*are)/i,
                /\b(job\s*title|position\s*title|role\s*title)\s*:?/i,
                /\b(reporting\s*to|manager|supervisor)/i,
                /\b(team|department|division)/i,
                /\b(immediate\s*start|start\s*date|available\s*immediately)/i,
                /\b(remote|hybrid|onsite|work\s*from\s*home)/i,
                /\b(hourly\s*rate|per\s*hour|\$\s*\d+|\d+\s*per\s*hour)/i,
            ];
            
            // Moderate job posting indicators
            const moderateJobIndicators = [
                /\b(location\s*:?\s*[^\n]+|work\s*location|office\s*location)/i,
                /\b(employment\s*type|job\s*type|full\s*time|part\s*time|contract)/i,
                /\b(equal\s*opportunity|eoe|diversity|inclusion)/i,
                /\b(must\s*have|required\s*skills|preferred\s*qualifications)/i,
                /\b(years?\s*of\s*experience|minimum\s*experience)/i,
                /\b(bachelor|master|phd|degree)\s*(required|preferred)/i,
                /\b(candidate|applicant|we\s*want|looking\s*for)/i,
                /\b(join\s*our|become\s*part|work\s*with\s*us)/i,
            ];
            
            let resumeScore = 0;
            let jobScore = 0;
            
            // Strong indicators count more
            strongResumeIndicators.forEach(pattern => {
                if (pattern.test(text)) resumeScore += 2;
            });
            
            moderateResumeIndicators.forEach(pattern => {
                if (pattern.test(text)) resumeScore += 1;
            });
            
            strongJobIndicators.forEach(pattern => {
                if (pattern.test(text)) jobScore += 2;
            });
            
            moderateJobIndicators.forEach(pattern => {
                if (pattern.test(text)) jobScore += 1;
            });
            
            // Require a clear winner with minimum threshold
            // Lower threshold to 1 for job postings since they can be more varied
            if (resumeScore > jobScore && resumeScore >= 2) return 'resume';
            if (jobScore > resumeScore && jobScore >= 1) return 'job'; // Lower threshold for job detection
            // If scores are equal or both low, check if one is clearly higher
            if (jobScore >= 1 && jobScore > resumeScore) return 'job';
            if (resumeScore >= 2 && resumeScore > jobScore) return 'resume';
            return 'unknown';
        }

        function showFieldError(type, message) {
            // Show error in the appropriate field based on current input mode
            const textError = document.getElementById(`${type}TextError`);
            const fileError = document.getElementById(`${type}FileError`);
            const currentMode = inputModes[type];
            
            // Only show error in the div that matches the current input mode
            if (currentMode === 'text' && textError) {
                // Hide file error, show text error
                if (fileError) fileError.style.display = 'none';
                textError.style.display = 'block';
                textError.textContent = message;
            } else if (fileError) {
                // Hide text error, show file error
                if (textError) textError.style.display = 'none';
                fileError.style.display = 'block';
                fileError.textContent = message;
            } else {
                // Fallback: show in both if mode is unclear
                if (textError) {
                    textError.style.display = 'block';
                    textError.textContent = message;
                }
                if (fileError) {
                    fileError.style.display = 'block';
                    fileError.textContent = message;
                }
            }
        }

        function clearFieldError(type) {
            const textError = document.getElementById(`${type}TextError`);
            const fileError = document.getElementById(`${type}FileError`);
            
            if (textError) textError.style.display = 'none';
            if (fileError) fileError.style.display = 'none';
        }

        function checkInputsReady() {
            const resumeInput = getInputValue('resume');
            const jobInput = getInputValue('job');
            const analyzeBtn = document.getElementById('analyzeBtn');
            
            // Check resume field independently
            let resumeValid = resumeInput !== null && resumeInput !== undefined && 
                               (resumeInput instanceof File || (typeof resumeInput === 'string' && resumeInput.trim().length > 0));
            let resumeHasError = false;
            
            clearFieldError('resume');
            
            // Check resume text length if it's text
            if (inputModes.resume === 'text' && typeof resumeInput === 'string') {
                if (resumeInput.length > MAX_RESUME_LENGTH) {
                    resumeValid = false;
                } else if (resumeInput.trim().length > 0) {
                    // Check if resume field contains job posting content
                    const contentType = detectContentType(resumeInput);
                    if (contentType === 'job') {
                        resumeValid = false;
                        resumeHasError = true;
                        showFieldError('resume', '‚ö†Ô∏è This looks like a job posting, not a resume. Please paste your resume in this field.');
                    }
                }
            }
            
            // Check job posting field independently
            let jobValid = false;
            let jobHasError = false;
            
            clearFieldError('job');
            
            if (inputModes.job === 'url') {
                // Simple URL validation - just check if it looks like a URL (more lenient)
                const trimmedUrl = jobInput && typeof jobInput === 'string' ? jobInput.trim() : '';
                // Basic check: has some text and contains a dot or starts with http
                jobValid = trimmedUrl.length > 0 && (trimmedUrl.includes('.') || trimmedUrl.startsWith('http'));
            } else if (inputModes.job === 'text') {
                jobValid = jobInput !== null && jobInput !== undefined && 
                           (jobInput instanceof File || (typeof jobInput === 'string' && jobInput.trim().length > 0));
                // Check job text length
                if (typeof jobInput === 'string') {
                    if (jobInput.length > MAX_JOB_POSTING_LENGTH) {
                        jobValid = false;
                    } else if (jobInput.trim().length > 0) {
                        // Check if job posting field contains resume content
                        const contentType = detectContentType(jobInput);
                        if (contentType === 'resume') {
                            jobValid = false;
                            jobHasError = true;
                            showFieldError('job', '‚ö†Ô∏è This looks like a resume, not a job posting. Please paste the job description in this field.');
                        }
                    }
                }
            } else {
                jobValid = jobInput !== null && jobInput !== undefined && 
                          (jobInput instanceof File || (typeof jobInput === 'string' && jobInput.trim().length > 0));
            }
            
            // Show errors in both fields if both are wrong
            if (resumeHasError && jobHasError) {
                // Both fields have swapped content - errors already shown above
            } else if (resumeHasError && !jobHasError) {
                // Only resume field is wrong - error already shown
            } else if (!resumeHasError && jobHasError) {
                // Only job field is wrong - error already shown
            }
            
            if (resumeValid && jobValid) {
                analyzeBtn.classList.add('ready');
                analyzeBtn.disabled = false;
            } else {
                analyzeBtn.classList.remove('ready');
                analyzeBtn.disabled = true;
            }
        }

        async function analyzeResume() {
            const resumeInput = getInputValue('resume');
            const jobInput = getInputValue('job');

            // Explicit validation with better error messages
            if (resumeInput === null || resumeInput === undefined) {
                alert('Please upload a resume file or paste your resume text.');
                return;
            }

            if (inputModes.resume === 'file') {
                if (!(resumeInput instanceof File)) {
                    alert('Please upload a valid resume file (PDF, DOC, or DOCX).');
                    return;
                }
            } else {
                if (typeof resumeInput !== 'string' || resumeInput.trim().length === 0) {
                    alert('Please paste your resume text. The text cannot be empty.');
                    return;
                }
                if (resumeInput.length > MAX_RESUME_LENGTH) {
                    alert(`Your resume text is too long. Maximum ${MAX_RESUME_LENGTH.toLocaleString()} characters allowed. Your text has ${resumeInput.length.toLocaleString()} characters. Please shorten your text and try again.`);
                    return;
                }
            }

            if (jobInput === null || jobInput === undefined) {
                alert('Please upload a job posting file, paste the job description, or paste a URL.');
                return;
            }

            if (inputModes.job === 'file') {
                if (!(jobInput instanceof File)) {
                    alert('Please upload a valid job posting file (PDF, DOC, or DOCX).');
                    return;
                }
            } else if (inputModes.job === 'url') {
                if (typeof jobInput !== 'string' || jobInput.trim().length === 0) {
                    alert('Please paste a valid job posting URL.');
                    return;
                }
            } else {
                if (typeof jobInput !== 'string' || jobInput.trim().length === 0) {
                    alert('Please paste the job description. The text cannot be empty.');
                    return;
                }
                if (jobInput.length > MAX_JOB_POSTING_LENGTH) {
                    alert(`Your job posting text is too long. Maximum ${MAX_JOB_POSTING_LENGTH.toLocaleString()} characters allowed. Your text has ${jobInput.length.toLocaleString()} characters. Please shorten your text and try again.`);
                    return;
                }
            }
            
            // Check both fields for swapped content AFTER basic validation passes
            let hasResumeError = false;
            let hasJobError = false;
            
            // Check resume field for swapped content (both file and text)
            if (inputModes.resume === 'text' && typeof resumeInput === 'string' && resumeInput.trim().length > 0) {
                const resumeContentType = detectContentType(resumeInput);
                if (resumeContentType === 'job') {
                    hasResumeError = true;
                    showFieldError('resume', '‚ö†Ô∏è This looks like a job posting, not a resume. Please paste your resume in this field.');
                }
            }
            // Note: File uploads will be checked on the server side
            
            // Check job posting field for swapped content (both file and text)
            if (inputModes.job === 'text' && typeof jobInput === 'string' && jobInput.trim().length > 0) {
                const jobContentType = detectContentType(jobInput);
                if (jobContentType === 'resume') {
                    hasJobError = true;
                    showFieldError('job', '‚ö†Ô∏è This looks like a resume, not a job posting. Please paste the job description in this field.');
                }
            }
            // Note: File uploads will be checked on the server side
            
            // If either field has swapped content, don't proceed
            if (hasResumeError || hasJobError) {
                return;
            }

            // Disable button during analysis
            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.disabled = true;

            // Show loading
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('resumeDisplay').style.display = 'none';
            document.getElementById('loadingSection').style.display = 'block';
            
            let jobPostingText = '';

            try {
                // If job input is a URL, fetch the content first
                if (inputModes.job === 'url') {
                    document.getElementById('loadingSection').querySelector('div:last-child').textContent = 'Fetching job posting from URL...';
                    try {
                        jobPostingText = await fetchUrlContent(jobInput.trim());
                        if (!jobPostingText || jobPostingText.trim().length < 50) {
                            // Error already shown inline, just return without analyzing
                            analyzeBtn.disabled = false;
                            document.getElementById('uploadSection').style.display = 'block';
                            document.getElementById('loadingSection').style.display = 'none';
                            return;
                        }
                    } catch (urlError) {
                        // Error already displayed inline in fetchUrlContent, just return
                        analyzeBtn.disabled = false;
                        document.getElementById('uploadSection').style.display = 'block';
                        document.getElementById('loadingSection').style.display = 'none';
                        return;
                    }
                }

            document.getElementById('loadingSection').querySelector('div:last-child').textContent = 'Analyzing your resume against the job posting...';

            const formData = new FormData();

            // Add resume - validation ensures resumeInput is valid at this point
            if (inputModes.resume === 'file' && resumeInput instanceof File) {
                formData.append('resume', resumeInput);
            } else if (typeof resumeInput === 'string' && resumeInput.trim().length > 0) {
                formData.append('resumeText', resumeInput);
            } else {
                // This should never happen due to validation above, but add safety check
                alert('Invalid resume input. Please try again.');
                analyzeBtn.disabled = false;
                document.getElementById('uploadSection').style.display = 'block';
                document.getElementById('loadingSection').style.display = 'none';
                return;
            }

            // Add job posting - validation ensures jobInput is valid at this point
            if (inputModes.job === 'file' && jobInput instanceof File) {
                formData.append('jobPosting', jobInput);
                } else if (inputModes.job === 'url' && jobPostingText) {
                    // Use fetched URL content
                    formData.append('jobPostingText', jobPostingText);
            } else if (typeof jobInput === 'string' && jobInput.trim().length > 0) {
                formData.append('jobPostingText', jobInput);
            } else {
                // This should never happen due to validation above, but add safety check
                alert('Invalid job posting input. Please try again.');
                analyzeBtn.disabled = false;
                document.getElementById('uploadSection').style.display = 'block';
                document.getElementById('loadingSection').style.display = 'none';
                return;
            }

                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    // Handle swapped content error
                    if (error.error === 'SWAPPED_CONTENT') {
                        throw new Error('SWAPPED_CONTENT:' + (error.message || 'Content appears to be in the wrong field.'));
                    }
                    throw new Error(error.error || 'Failed to analyze resume');
                }

                const data = await response.json();
                currentAnalysis = data.analysis;
                currentResumeText = data.resumeText || '';
                currentJobPostingText = data.jobPostingText || '';
                displayResults(data);
                
                // Update resume counter after successful analysis
                loadResumeCount();
            } catch (error) {
                // Don't show alert for URL fetch errors - they're already shown inline
                const isUrlError = inputModes.job === 'url' && (
                    error.message.includes('URL') || 
                    error.message.includes('fetch') || 
                    error.message.includes('extract') ||
                    error.message.includes('ACCESS_REQUIRED') ||
                    error.message.includes('NOT_FOUND')
                );
                
                // Handle swapped content error - show inline instead of alert
                if (error.message.startsWith('SWAPPED_CONTENT:')) {
                    const errorMsg = error.message.replace('SWAPPED_CONTENT:', '');
                    // Determine which field has the issue based on server message
                    // Server messages:
                    // - "The content in "Your Resume" field appears to be a job posting..."
                    // - "The content in "Job Posting" field appears to be a resume..."
                    
                    console.log('SWAPPED_CONTENT error:', errorMsg);
                    
                    const lowerMsg = errorMsg.toLowerCase();
                    let targetField = null;
                    
                    // Explicit detection based on server message structure
                    // Pattern 1: "Your Resume" field + "job posting" = resume field has job content ‚Üí show error in resume
                    if (lowerMsg.includes('your resume') && lowerMsg.includes('job posting')) {
                        targetField = 'resume';
                        console.log('Detected: Resume field has job posting content');
                    }
                    // Pattern 2: "Job Posting" field + "resume" = job field has resume content ‚Üí show error in job
                    else if (lowerMsg.includes('job posting') && lowerMsg.includes('resume') && !lowerMsg.includes('your resume')) {
                        targetField = 'job';
                        console.log('Detected: Job field has resume content');
                    }
                    // Pattern 3: Just "Your Resume" mentioned ‚Üí error in resume field
                    else if (lowerMsg.includes('your resume')) {
                        targetField = 'resume';
                        console.log('Detected: Error in resume field (pattern 3)');
                    }
                    // Pattern 4: Just "Job Posting" mentioned ‚Üí error in job field
                    else if (lowerMsg.includes('job posting')) {
                        targetField = 'job';
                        console.log('Detected: Error in job field (pattern 4)');
                    }
                    
                    if (targetField) {
                        // Clean up the message to remove field name references
                        const cleanMsg = errorMsg
                            .replace(/["']Your Resume["'] field/gi, 'this field')
                            .replace(/["']Your Resume["']/gi, 'this field')
                            .replace(/["']Job Posting["'] field/gi, 'this field')
                            .replace(/["']Job Posting["']/gi, 'this field');
                        showFieldError(targetField, '‚ö†Ô∏è ' + cleanMsg);
                    } else {
                        // Fallback: show in both fields if we can't determine
                        showFieldError('resume', '‚ö†Ô∏è ' + errorMsg);
                        showFieldError('job', '‚ö†Ô∏è ' + errorMsg);
                    }
                    showUpload();
                    return;
                }
                
                if (!isUrlError) {
                alert('Error: ' + error.message);
                }
                showUpload();
            } finally {
                // Re-enable button
                const analyzeBtn = document.getElementById('analyzeBtn');
                analyzeBtn.disabled = false;
            }
        }

        function displayResults(data) {
            const analysis = data.analysis;
            const resumeText = data.resumeText || '';

            // Show entire sidebar after analysis
            document.getElementById('sidebar').style.display = 'block';
            // Switch from promotional to functional content
            document.getElementById('promoContent').style.display = 'none';
            document.getElementById('functionalContent').style.display = 'block';
            // Show score gauge
            document.getElementById('scoreGaugeContainer').style.display = 'block';
            document.getElementById('topFixesTitle').style.display = 'block';
            document.getElementById('completedTitle').style.display = 'block';
            // Show tools section after analysis
            document.getElementById('toolsTitle').style.display = 'block';
            document.getElementById('toolsList').style.display = 'block';

            // Update score
            const score = analysis.score || analysis.overall || 0;
            document.getElementById('scoreNumber').textContent = score;
            document.getElementById('scoreGauge').style.setProperty('--score', score);
            document.getElementById('scoreHeading').textContent = `Your resume scored ${score} out of 100.`;
            document.getElementById('scoreBar').style.setProperty('--score-percent', score + '%');
            
            // Gauge color now automatically matches horizontal bar gradient

            // Update welcome text with user name if available
            const userName = extractName(resumeText) || 'User';
            const timeOfDay = getTimeOfDay();
            document.getElementById('welcomeText').textContent = `Good ${timeOfDay}, ${userName}. Welcome to your resume review.`;

            // Update top fixes
            const topFixesList = document.getElementById('topFixesList');
            topFixesList.innerHTML = '';
            const topFixesToShow = 5;
            
            if (analysis.topFixes && analysis.topFixes.length > 0) {
                analysis.topFixes.slice(0, topFixesToShow).forEach(fix => {
                    const item = document.createElement('div');
                    item.className = 'issue-item';
                    item.innerHTML = `
                        <span>${fix.title}</span>
                        ${fix.premium ? '<span class="issue-lock">üîí</span>' : `<span class="issue-count">${fix.count || ''}</span>`}
                    `;
                    topFixesList.appendChild(item);
                });
            } else {
                // Default fixes
                topFixesList.innerHTML = `
                    <div class="issue-item"><span>Quantify impact</span><span class="issue-count">4</span></div>
                    <div class="issue-item"><span>Skills section</span><span class="issue-lock">üîí</span></div>
                    <div class="issue-item"><span>Weak roles</span><span class="issue-count">3</span></div>
                    <div class="issue-item"><span>Unnecessary sec...</span><span class="issue-count">5</span></div>
                    <div class="issue-item"><span>Weak verbs</span><span class="issue-lock">üîí</span></div>
                `;
            }

            // Update "More Issues" button - show correct count or hide if all issues are displayed
            const moreIssuesBtn = document.getElementById('moreIssuesBtn');
            const totalIssues = (analysis.issues && analysis.issues.length > 0) ? analysis.issues.length : 0;
            const issuesShownInSidebar = 5; // We show up to 5 top fixes in the sidebar
            const remainingIssues = totalIssues - issuesShownInSidebar;
            
            if (remainingIssues > 0) {
                moreIssuesBtn.textContent = `${remainingIssues} MORE ISSUES +`;
                moreIssuesBtn.style.display = 'block';
            } else {
                moreIssuesBtn.style.display = 'none';
            }

            // Update completed
            const completedList = document.getElementById('completedList');
            completedList.innerHTML = '';
            if (analysis.completed && analysis.completed.length > 0) {
                analysis.completed.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'completed-item';
                    div.innerHTML = `
                        <span>${item.title}</span>
                        <span class="completed-score">${item.score || 10}</span>
                    `;
                    completedList.appendChild(div);
                });
            } else {
                // Default completed
                completedList.innerHTML = `
                    <div class="completed-item"><span>Repetition</span><span class="completed-score">10</span></div>
                    <div class="completed-item"><span>Contact details</span><span class="completed-score">10</span></div>
                    <div class="completed-item"><span>Use of bullets</span><span class="completed-score">10</span></div>
                `;
            }

            // Update issues
            const issuesList = document.getElementById('issuesList');
            issuesList.innerHTML = '';
            if (analysis.issues && analysis.issues.length > 0) {
                analysis.issues.forEach(issue => {
                    const card = document.createElement('div');
                    card.className = 'issue-card';
                    card.innerHTML = `
                        <div class="issue-info">
                            <div class="issue-title">
                                <span class="issue-icon">‚úó</span>
                                ${issue.title}
                            </div>
                            <div class="issue-desc">${issue.description}</div>
                        </div>
                        <button class="fix-btn" onclick="fixIssue('${issue.category || issue.title}')">${issue.fixButton || 'FIX'} ‚Üí</button>
                    `;
                    issuesList.appendChild(card);
                });
            } else {
                // Default issue
                const card = document.createElement('div');
                card.className = 'issue-card';
                card.innerHTML = `
                    <div class="issue-info">
                        <div class="issue-title">
                            <span class="issue-icon">‚úó</span>
                            Quantify impact
                        </div>
                        <div class="issue-desc">Add more numbers to quantify your accomplishments.</div>
                    </div>
                    <button class="fix-btn" onclick="fixIssue('impact')">IMPACT ‚Üí</button>
                `;
                issuesList.appendChild(card);
            }

            // Display resume
            displayResume(resumeText);

            // Show results
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('resumeDisplay').style.display = 'block';
        }

        function displayResume(text) {
            const resumeContent = document.getElementById('resumeContent');
            
            if (!text || text.trim().length === 0) {
                resumeContent.innerHTML = '<div style="color: #666; font-style: italic;">No resume content to display.</div>';
                return;
            }
            
            // Check if this is actually resume content (not job posting)
            const contentType = detectContentType(text);
            if (contentType === 'job') {
                resumeContent.innerHTML = '<div style="color: #dc2626; padding: 16px; background: #fee2e2; border-radius: 8px;">‚ö†Ô∏è Warning: This appears to be job posting content, not a resume. Please check your inputs.</div>';
                return;
            }
            
            // Simple parsing - in production, use a more sophisticated parser
            const lines = text.split('\n').filter(line => line.trim());
            
            if (lines.length === 0) {
                resumeContent.innerHTML = `<div style="white-space: pre-wrap; font-size: 12px; line-height: 1.6;">${text}</div>`;
                return;
            }
            
            let html = '';
            let currentSection = '';
            
            lines.forEach((line, index) => {
                const trimmed = line.trim();
                
                // Detect name (usually first line with title case)
                if (index === 0 && trimmed.length < 50 && /^[A-Z]/.test(trimmed)) {
                    html += `<div class="resume-name">${trimmed}</div>`;
                }
                // Detect section headers
                else if (trimmed.length < 30 && /^[A-Z\s&]+$/.test(trimmed)) {
                    if (currentSection) html += '</div>';
                    currentSection = trimmed.toLowerCase().replace(/\s+/g, '-');
                    html += `<div class="resume-section"><div class="resume-section-title">${trimmed}</div>`;
                }
                // Detect bullet points
                else if (trimmed.startsWith('‚Ä¢') || trimmed.startsWith('-') || trimmed.match(/^\d+\./)) {
                    html += `<ul class="resume-item-bullets"><li>${trimmed.replace(/^[‚Ä¢\-\d+\.]\s*/, '')}</li></ul>`;
                }
                // Regular content
                else if (trimmed) {
                    html += `<div class="resume-item">${trimmed}</div>`;
                }
            });
            
            if (currentSection) html += '</div>';
            
            resumeContent.innerHTML = html || `<div style="white-space: pre-wrap; font-size: 12px; line-height: 1.6;">${text}</div>`;
        }

        function extractName(text) {
            // Simple name extraction - first line that looks like a name
            const lines = text.split('\n').filter(line => line.trim());
            if (lines.length > 0) {
                const firstLine = lines[0].trim();
                if (firstLine.length < 50 && /^[A-Z][a-z]+/.test(firstLine)) {
                    return firstLine.split(/\s+/)[0];
                }
            }
            return null;
        }

        function getTimeOfDay() {
            const hour = new Date().getHours();
            if (hour < 12) return 'morning';
            if (hour < 17) return 'afternoon';
            return 'evening';
        }

        async function fixIssue(category) {
            if (!currentAnalysis) {
                alert('Please analyze your resume first.');
                return;
            }

            // Find the issue by category
            const issue = currentAnalysis.issues?.find(i => 
                (i.category && i.category.toLowerCase() === category.toLowerCase()) ||
                (i.title && i.title.toLowerCase().includes(category.toLowerCase()))
            );

            if (!issue) {
                // If not found, create a generic fix guide
                showFixGuide(category, `Here's how to fix "${category}" issues in your resume:`, 
                    `To address ${category} issues:\n\n1. Review the job posting requirements related to ${category}\n2. Identify gaps in your resume\n3. Add relevant experience, skills, or achievements\n4. Use keywords from the job posting\n5. Quantify your impact where possible`, null);
                return;
            }

            // Special handling for specific issue types
            const issueTitleLower = issue.title.toLowerCase();
            if (issueTitleLower.includes('keyword') || issueTitleLower.includes('ats')) {
                // Use the ATS optimization tool
                await optimizeATS();
                return;
            }

            if (issueTitleLower.includes('qualification') || issueTitleLower.includes('missing qualification')) {
                // Use the missing qualifications tool
                await addMissingQualifications();
                return;
            }

            // Show loading state
            const loadingModal = document.createElement('div');
            loadingModal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            loadingModal.innerHTML = `
                <div style="background: white; padding: 32px; border-radius: 12px; text-align: center;">
                    <div class="spinner" style="margin: 0 auto 16px;"></div>
                    <div>Generating detailed fix suggestions...</div>
                </div>
            `;
            document.body.appendChild(loadingModal);

            try {
                // Call API for detailed fix suggestions
                const response = await fetch('/api/fix-issue', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        issueTitle: issue.title,
                        issueDescription: issue.description,
                        resume: currentResumeText,
                        jobPosting: currentJobPostingText
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to generate fix suggestions');
                }

                const fixData = await response.json();
                loadingModal.remove();
                showDetailedFixGuide(issue.title, issue.description, fixData);
            } catch (error) {
                loadingModal.remove();
                // Fallback to basic guide if API fails
                showFixGuide(issue.title, issue.description, 
                    `Detailed Fix Guide for: ${issue.title}\n\n${issue.description}\n\nTo fix this issue:\n1. Review the specific requirements mentioned in the job posting\n2. Identify where you can add relevant experience or skills\n3. Update your resume with concrete examples\n4. Use action verbs and quantify achievements where possible`, null);
            }
        }

        function showFixGuide(title, description, detailedGuide, fixData) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            modal.innerHTML = `
                <div style="background: white; padding: 32px; border-radius: 12px; max-width: 700px; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="margin: 0; font-size: 24px; font-weight: 600;">Fix Guide: ${title}</h2>
                        <button onclick="this.closest('.modal-overlay').remove()" style="background: transparent; border: none; font-size: 24px; cursor: pointer; color: #666;">√ó</button>
                    </div>
                    <div style="margin-bottom: 24px;">
                        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">Issue Description:</h3>
                        <div style="background: #f5f5f5; padding: 16px; border-radius: 8px; font-size: 14px; line-height: 1.6;">${description}</div>
                    </div>
                    <div>
                        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">How to Fix:</h3>
                        <div style="background: #f0f7ff; padding: 16px; border-radius: 8px; white-space: pre-wrap; font-size: 14px; line-height: 1.6;">${detailedGuide}</div>
                    </div>
                    <button onclick="this.closest('.modal-overlay').remove()" style="margin-top: 24px; width: 100%; padding: 12px; background: #2563eb; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer;">Close</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showDetailedFixGuide(title, description, fixData) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            
            let content = `
                <div style="background: white; padding: 32px; border-radius: 12px; max-width: 800px; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="margin: 0; font-size: 24px; font-weight: 600;">Fix Guide: ${title}</h2>
                        <button onclick="this.closest('.modal-overlay').remove()" style="background: transparent; border: none; font-size: 24px; cursor: pointer; color: #666;">√ó</button>
                    </div>
                    <div style="margin-bottom: 24px;">
                        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">Issue Description:</h3>
                        <div style="background: #f5f5f5; padding: 16px; border-radius: 8px; font-size: 14px; line-height: 1.6;">${description}</div>
                    </div>
            `;

            // Step-by-step guide
            if (fixData.stepByStepGuide && fixData.stepByStepGuide.length > 0) {
                content += `
                    <div style="margin-bottom: 24px;">
                        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">Step-by-Step Guide:</h3>
                        <ol style="padding-left: 20px; line-height: 1.8;">
                            ${fixData.stepByStepGuide.map(step => `<li style="margin-bottom: 8px; font-size: 14px;">${step}</li>`).join('')}
                        </ol>
                    </div>
                `;
            }

            // Before/After examples
            if (fixData.beforeAfterExamples && fixData.beforeAfterExamples.length > 0) {
                content += `
                    <div style="margin-bottom: 24px;">
                        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">Before & After Examples:</h3>
                        ${fixData.beforeAfterExamples.map(example => `
                            <div style="margin-bottom: 16px; padding: 16px; background: #f9fafb; border-radius: 8px; border-left: 4px solid #ef4444;">
                                <div style="margin-bottom: 8px;">
                                    <strong style="color: #ef4444; font-size: 13px;">BEFORE:</strong>
                                    <div style="font-size: 13px; color: #666; margin-top: 4px;">${example.before}</div>
                                </div>
                                <div>
                                    <strong style="color: #10b981; font-size: 13px;">AFTER:</strong>
                                    <div style="font-size: 13px; color: #333; margin-top: 4px; font-weight: 500;">${example.after}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // Specific examples
            if (fixData.specificExamples && fixData.specificExamples.length > 0) {
                content += `
                    <div style="margin-bottom: 24px;">
                        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">Specific Examples:</h3>
                        <ul style="padding-left: 20px; line-height: 1.8;">
                            ${fixData.specificExamples.map(example => `<li style="margin-bottom: 8px; font-size: 14px;">${example}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            // Keywords to add
            if (fixData.keywordsToAdd && fixData.keywordsToAdd.length > 0) {
                content += `
                    <div style="margin-bottom: 24px;">
                        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">Keywords to Add:</h3>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            ${fixData.keywordsToAdd.map(keyword => `
                                <span style="background: #2563eb; color: white; padding: 6px 12px; border-radius: 6px; font-size: 13px; font-weight: 500;">${keyword}</span>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Tips
            if (fixData.tips) {
                content += `
                    <div style="margin-bottom: 24px;">
                        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">Additional Tips:</h3>
                        <div style="background: #fef3c7; padding: 16px; border-radius: 8px; font-size: 14px; line-height: 1.6; border-left: 4px solid #f59e0b;">
                            ${fixData.tips}
                        </div>
                    </div>
                `;
            }

            content += `
                    <button onclick="this.closest('.modal-overlay').remove()" style="margin-top: 24px; width: 100%; padding: 12px; background: #2563eb; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer;">Close</button>
                </div>
            `;

            modal.innerHTML = content;
            document.body.appendChild(modal);
        }

        function showAllIssues() {
            if (!currentAnalysis || !currentAnalysis.issues) {
                alert('Please analyze your resume first.');
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            
            const issuesHtml = currentAnalysis.issues.map((issue, index) => `
                <div style="padding: 16px; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                        <h4 style="margin: 0; font-size: 16px; font-weight: 600; color: #333;">${index + 1}. ${issue.title}</h4>
                        <button onclick="fixIssue('${issue.category || issue.title}'); this.closest('.modal-overlay').remove();" style="background: #2563eb; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">Fix ‚Üí</button>
                    </div>
                    <p style="margin: 0; font-size: 14px; color: #666; line-height: 1.5;">${issue.description}</p>
                </div>
            `).join('');

            modal.innerHTML = `
                <div style="background: white; padding: 32px; border-radius: 12px; max-width: 800px; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="margin: 0; font-size: 24px; font-weight: 600;">All Issues (${currentAnalysis.issues.length})</h2>
                        <button onclick="this.closest('.modal-overlay').remove()" style="background: transparent; border: none; font-size: 24px; cursor: pointer; color: #666;">√ó</button>
                    </div>
                    <div>
                        ${issuesHtml}
                    </div>
                    <button onclick="this.closest('.modal-overlay').remove()" style="margin-top: 24px; width: 100%; padding: 12px; background: #2563eb; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer;">Close</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function rewriteResume() {
            console.log('rewriteResume called');
            showFeatureRequestModal('Rewrite My Resume', 'This feature will use AI to rewrite your resume based on the job posting requirements, helping you tailor it perfectly for each application.');
        }

        async function optimizeATS() {
            if (!currentAnalysis || !currentResumeText || !currentJobPostingText) {
                alert('Please analyze your resume first.');
                return;
            }

            // Show loading
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'atsLoading';
            loadingDiv.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            loadingDiv.innerHTML = '<div style="background: white; padding: 24px; border-radius: 8px;"><div class="spinner"></div><div>Analyzing missing ATS keywords...</div></div>';
            document.body.appendChild(loadingDiv);

            try {
                const response = await fetch('/api/optimize-ats', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        resume: currentResumeText,
                        jobPosting: currentJobPostingText
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to optimize ATS keywords');
                }

                const data = await response.json();
                loadingDiv.remove();
                
                // Show results in a modal
                showToolResults('ATS Keywords Optimization', data.keywords, data.suggestions);
            } catch (error) {
                loadingDiv.remove();
                alert('Error: ' + error.message);
            }
        }

        async function addMissingQualifications() {
            if (!currentAnalysis || !currentResumeText || !currentJobPostingText) {
                alert('Please analyze your resume first.');
                return;
            }

            // Show loading
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'qualLoading';
            loadingDiv.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            loadingDiv.innerHTML = '<div style="background: white; padding: 24px; border-radius: 8px;"><div class="spinner"></div><div>Analyzing missing qualifications...</div></div>';
            document.body.appendChild(loadingDiv);

            try {
                const response = await fetch('/api/missing-qualifications', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        resume: currentResumeText,
                        jobPosting: currentJobPostingText
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to analyze missing qualifications');
                }

                const data = await response.json();
                loadingDiv.remove();
                
                // Show results in a modal
                showToolResults('Missing Qualifications', data.qualifications, data.suggestions);
            } catch (error) {
                loadingDiv.remove();
                alert('Error: ' + error.message);
            }
        }

        function showToolResults(title, items, suggestions) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            modal.innerHTML = `
                <div style="background: white; padding: 32px; border-radius: 12px; max-width: 600px; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="margin: 0; font-size: 24px; font-weight: 600;">${title}</h2>
                        <button onclick="this.closest('.modal-overlay').remove()" style="background: transparent; border: none; font-size: 24px; cursor: pointer; color: #666;">√ó</button>
                    </div>
                    <div style="margin-bottom: 24px;">
                        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">Missing Items:</h3>
                        <ul style="list-style: none; padding: 0;">
                            ${items.map(item => `<li style="padding: 8px 0; border-bottom: 1px solid #e0e0e0;">‚Ä¢ ${item}</li>`).join('')}
                        </ul>
                    </div>
                    ${suggestions ? `
                    <div>
                        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">Suggestions:</h3>
                        <div style="background: #f5f5f5; padding: 16px; border-radius: 8px; white-space: pre-wrap; font-size: 14px; line-height: 1.6;">${suggestions}</div>
                    </div>
                    ` : ''}
                    <button onclick="this.closest('.modal-overlay').remove()" style="margin-top: 24px; width: 100%; padding: 12px; background: #2563eb; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer;">Close</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function improveBullets() {
            showFeatureRequestModal('Improve Bullet Points', 'This feature will enhance your bullet points to better match the job requirements, making your accomplishments stand out to recruiters.');
        }

        function addQuantification() {
            showFeatureRequestModal('Add Quantification', 'This feature will suggest where to add numbers and metrics to strengthen your resume, helping you quantify your achievements.');
        }

        function showFeatureRequestModal(featureName, featureDescription) {
            console.log('showFeatureRequestModal called with:', featureName);
            // Escape HTML to prevent XSS
            const escapeHtml = (text) => {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            };
            
            const escapedName = escapeHtml(featureName);
            const escapedDescription = escapeHtml(featureDescription);
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            modal.innerHTML = `
                <div style="background: white; padding: 32px; border-radius: 12px; max-width: 500px; box-shadow: 0 20px 40px rgba(0,0,0,0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="margin: 0; font-size: 24px; font-weight: 600;">${escapedName}</h2>
                        <button onclick="this.closest('.modal-overlay').remove()" style="background: transparent; border: none; font-size: 24px; cursor: pointer; color: #666;">√ó</button>
                    </div>
                    <div style="margin-bottom: 24px;">
                        <p style="color: #666; font-size: 15px; line-height: 1.6; margin-bottom: 16px;">${escapedDescription}</p>
                        <div style="background: #fef3c7; padding: 16px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                            <p style="margin: 0; color: #333; font-size: 14px; line-height: 1.5;">
                                <strong>Coming Soon!</strong><br>
                                This feature is in our roadmap. If you'd like to see it released sooner, vote below! We'll prioritize features with more requests.
                            </p>
                        </div>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-size: 14px; font-weight: 500; color: #333; margin-bottom: 8px;">
                            Email (optional - to be notified when this feature is available)
                        </label>
                        <input type="email" id="feature-request-email" placeholder="your.email@example.com" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; font-family: inherit; box-sizing: border-box;">
                        <p style="margin: 6px 0 0 0; font-size: 12px; color: #666;">We'll only use this to notify you when the feature is ready</p>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button class="vote-feature-btn" data-feature="${escapedName}" style="flex: 1; padding: 12px; background: #2563eb; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: background 0.2s;">Vote to Release Sooner</button>
                        <button onclick="this.closest('.modal-overlay').remove()" style="padding: 12px 24px; background: #f5f5f5; color: #666; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: background 0.2s;">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add event listener to vote button to avoid inline onclick issues with quotes
            const voteBtn = modal.querySelector('.vote-feature-btn');
            if (voteBtn) {
                voteBtn.addEventListener('click', function() {
                    const feature = this.getAttribute('data-feature');
                    const emailInput = modal.querySelector('#feature-request-email');
                    const userEmail = emailInput ? emailInput.value.trim() : '';
                    
                    // Validate email if provided
                    if (userEmail && !isValidEmail(userEmail)) {
                        alert('Please enter a valid email address or leave it blank.');
                        return;
                    }
                    
                    requestFeature(feature, userEmail);
                    modal.remove();
                });
            }
            
        }
        
        // Helper function to validate email
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        async function requestFeature(featureName, userEmail = '') {
            try {
                const response = await fetch('/api/request-feature', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        featureName,
                        userEmail: userEmail || null
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to submit request');
                }

                const data = await response.json();
                
                // Show success message
                const successModal = document.createElement('div');
                successModal.className = 'modal-overlay';
                successModal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10001;';
                
                const emailMessage = data.userEmail 
                    ? ` We'll notify you at ${data.userEmail} when this feature is available!` 
                    : ' Keep an eye out for updates!';
                
                successModal.innerHTML = `
                    <div style="background: white; padding: 32px; border-radius: 12px; max-width: 400px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 16px;">‚úÖ</div>
                        <h2 style="margin: 0 0 12px 0; font-size: 20px; font-weight: 600;">Thank You!</h2>
                        <p style="color: #666; font-size: 14px; line-height: 1.6; margin-bottom: 24px;">Your vote for "${featureName}" has been recorded.${emailMessage}</p>
                        <button onclick="this.closest('.modal-overlay').remove()" style="width: 100%; padding: 12px; background: #2563eb; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer;">Close</button>
                    </div>
                `;
                document.body.appendChild(successModal);
            } catch (error) {
                alert('Error submitting request. Please try again later.');
                console.error('Feature request error:', error);
            }
        }

        function showHowItWorks() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            modal.innerHTML = `
                <div style="background: white; padding: 32px; border-radius: 12px; max-width: 700px; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="margin: 0; font-size: 24px; font-weight: 600;">How It Works</h2>
                        <button onclick="this.closest('.modal-overlay').remove()" style="background: transparent; border: none; font-size: 24px; cursor: pointer; color: #666;">√ó</button>
                    </div>
                    <div style="line-height: 1.8; font-size: 15px; color: #333;">
                        <div style="margin-bottom: 24px;">
                            <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 12px; color: #2563eb;">1. Upload Your Resume & Job Posting</h3>
                            <p style="color: #666; margin-bottom: 8px;">Upload your resume (PDF, DOC, or paste text) and the job posting you're applying for. For job postings, you can upload a file, paste the text, or paste a URL from job boards like LinkedIn, Indeed, etc. Our AI will analyze both documents to understand the requirements.</p>
                        </div>
                        <div style="margin-bottom: 24px;">
                            <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 12px; color: #2563eb;">2. Get Your Score</h3>
                            <p style="color: #666; margin-bottom: 8px;">We'll give you a score from 0-100 that reflects how well your resume matches the job posting. This score is based on:</p>
                            <ul style="color: #666; padding-left: 20px; margin-top: 8px;">
                                <li>Job-relevant content and skills match (40%)</li>
                                <li>Keyword alignment with job posting (25%)</li>
                                <li>Experience relevance to job requirements (20%)</li>
                                <li>Quantified achievements relevant to the role (15%)</li>
                            </ul>
                        </div>
                        <div style="margin-bottom: 24px;">
                            <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 12px; color: #2563eb;">3. Review Issues & Fixes</h3>
                            <p style="color: #666; margin-bottom: 8px;">We'll identify specific areas where your resume can be improved. Click on any issue to see detailed suggestions on how to fix it, including:</p>
                            <ul style="color: #666; padding-left: 20px; margin-top: 8px;">
                                <li>Step-by-step guides</li>
                                <li>Before and after examples</li>
                                <li>Keywords to add</li>
                                <li>Specific examples tailored to your resume</li>
                            </ul>
                        </div>
                        <div style="margin-bottom: 24px;">
                            <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 12px; color: #2563eb;">4. Use Our Tools</h3>
                            <p style="color: #666; margin-bottom: 8px;">Take advantage of our AI-powered tools to optimize your resume:</p>
                            <ul style="color: #666; padding-left: 20px; margin-top: 8px;">
                                <li><strong>Optimize ATS Keywords:</strong> Find missing keywords from the job posting</li>
                                <li><strong>Add Missing Qualifications:</strong> Identify gaps in your qualifications</li>
                            </ul>
                        </div>
                        <div style="margin-bottom: 24px;">
                            <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 12px; color: #2563eb;">5. Revise & Re-upload</h3>
                            <p style="color: #666; margin-bottom: 8px;">Make the suggested improvements to your resume, then upload it again to get a new score. Most users see a 20+ point increase after just a few revisions!</p>
                        </div>
                        <div style="background: #f0f7ff; padding: 16px; border-radius: 8px; border-left: 4px solid #2563eb; margin-top: 24px;">
                            <p style="margin: 0; color: #333; font-weight: 500;">üí° <strong>Tip:</strong> The more you tailor your resume to each specific job posting, the higher your score will be. Focus on matching keywords, highlighting relevant experience, and quantifying your achievements.</p>
                        </div>
                    </div>
                    <button onclick="this.closest('.modal-overlay').remove()" style="margin-top: 24px; width: 100%; padding: 12px; background: #2563eb; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer;">Close</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Setup drag and drop and input listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Add event listeners for text inputs with character count updates
            const resumeTextInput = document.getElementById('resumeTextInput');
            const jobTextInput = document.getElementById('jobTextInput');
            
            if (resumeTextInput) {
                resumeTextInput.addEventListener('input', () => {
                    updateTextCount('resume');
                    checkInputsReady();
                });
            }
            
            if (jobTextInput) {
                jobTextInput.addEventListener('input', () => {
                    updateTextCount('job');
                    checkInputsReady();
                });
            }
            
            // Add event listener for URL input with debouncing
            const jobUrlInput = document.getElementById('jobUrlInput');
            if (jobUrlInput) {
                jobUrlInput.addEventListener('input', () => {
                    // Clear previous timeout
                    if (urlInputTimeout) {
                        clearTimeout(urlInputTimeout);
                    }
                    // Debounce: wait 300ms after user stops typing
                    urlInputTimeout = setTimeout(() => {
                        checkInputsReady();
                    }, 300);
                });
                // Also check on blur (when user clicks away)
                jobUrlInput.addEventListener('blur', () => {
                    if (urlInputTimeout) {
                        clearTimeout(urlInputTimeout);
                    }
                    checkInputsReady();
                });
            }
            
            // Add event listeners for file inputs
            document.getElementById('resumeFileInput').addEventListener('change', (e) => {
                // Clear any previously dropped file when a new file is selected
                e.target._droppedFile = null;
                checkInputsReady();
            });
            document.getElementById('jobFileInput').addEventListener('change', (e) => {
                // Clear any previously dropped file when a new file is selected
                e.target._droppedFile = null;
                checkInputsReady();
            });
            
            // Initial check and update character counts
            checkInputsReady();
            updateTextCount('resume');
            updateTextCount('job');
            
            const uploadAreas = document.querySelectorAll('.upload-area');
            
            uploadAreas.forEach((uploadArea, index) => {
                const type = index === 0 ? 'resume' : 'job';
                const fileInput = document.getElementById(`${type}FileInput`);
                
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.style.borderColor = '#2563eb';
                    uploadArea.style.background = '#f0f7ff';
                });
                
                uploadArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    uploadArea.style.borderColor = '#d0d0d0';
                    uploadArea.style.background = 'white';
                });
                
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.style.borderColor = '#d0d0d0';
                    uploadArea.style.background = 'white';
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        // Store the file on the input element since files property is read-only
                        fileInput._droppedFile = files[0];
                        
                        // Create a DataTransfer object to properly handle the file
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(files[0]);
                        
                        // Create a synthetic event object that mimics a file input
                        const syntheticEvent = {
                            target: {
                                files: dataTransfer.files,
                                parentElement: fileInput.parentElement
                            }
                        };
                        
                        // Call handleFileUpload with the synthetic event
                        handleFileUpload(type, syntheticEvent);
                        
                        // Trigger change event on the file input so checkInputsReady() works
                        const changeEvent = new Event('change', { bubbles: true });
                        fileInput.dispatchEvent(changeEvent);
                    }
                });
            });
        });

        // Load and display resume counter
        async function loadResumeCount() {
            try {
                const response = await fetch('/api/resume-count');
                if (response.ok) {
                    const data = await response.json();
                    const countElement = document.getElementById('resumeCount');
                    const footerElement = document.querySelector('.footer');
                    
                    if (countElement) {
                        countElement.textContent = data.count.toLocaleString();
                    }
                    
                    // Only show footer if more than 10 people have checked
                    if (footerElement) {
                        if (data.count > 10) {
                            footerElement.style.display = 'block';
                        } else {
                            footerElement.style.display = 'none';
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading resume count:', error);
            }
        }

        // Load counter on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadResumeCount();
        });
    </script>
</body>
</html>

